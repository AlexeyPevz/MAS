<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Root-MAS - Multi-Agent System</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Root-MAS">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π */
        .thought-bubble {
            transition: all 0.3s ease;
        }
        
        .thought-bubble.animate-in {
            animation: thoughtIn 0.5s ease-out;
        }
        
        @keyframes thoughtIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .agent-avatar {
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        
        .agent-avatar.active {
            border-color: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
            animation: pulse 2s infinite;
        }
        
        .agent-avatar.thinking {
            border-color: #f59e0b;
            animation: thinking 1.5s infinite;
        }
        
        @keyframes thinking {
            0%, 100% { border-color: #f59e0b; }
            50% { border-color: #fbbf24; }
        }
        
        .message-flow-line {
            stroke-dasharray: 5,5;
            animation: dash 1s linear infinite;
        }
        
        @keyframes dash {
            to { stroke-dashoffset: -10; }
        }
        
        .typing-indicator::after {
            content: '...';
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0%, 33% { content: '.'; }
            34%, 66% { content: '..'; }
            67%, 100% { content: '...'; }
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Ç–æ–∫–∞ */
        .flow-stage {
            transition: all 0.5s ease;
        }
        
        .flow-stage.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            transform: scale(1.05);
        }
        
        .agent-network {
            background: radial-gradient(circle at center, #f8fafc 0%, #e2e8f0 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-blue-600">ü§ñ Root-MAS</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="chatModeBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-comments mr-2"></i>–ß–∞—Ç
                    </button>
                    <button id="visualizationModeBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        <i class="fas fa-brain mr-2"></i>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
                    </button>
                    <button id="dashboardModeBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-chart-line mr-2"></i>–î–∞—à–±–æ—Ä–¥
                    </button>
                    <button id="studioModeBtn" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                        <i class="fas fa-cogs mr-2"></i>–°—Ç—É–¥–∏—è
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Chat Mode -->
    <div id="chatMode" class="max-w-4xl mx-auto p-6 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">üí¨ –ß–∞—Ç —Å MAS</h2>
            
            <div id="chatContainer" class="h-96 overflow-y-auto border rounded-lg p-4 mb-4 bg-gray-50">
                <div class="text-gray-500 text-center">–ù–∞—á–Ω–∏—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥–æ–π –∞–≥–µ–Ω—Ç–æ–≤...</div>
            </div>
            
            <div class="flex gap-2">
                <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                       class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="sendMessageBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button id="voiceBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Visualization Mode -->
    <div id="visualizationMode" class="max-w-7xl mx-auto p-6">
        <!-- Flow Stages -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">üß† –ú—ã—Å–ª–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å MAS</h2>
            
            <div class="flex justify-between items-center mb-6">
                <div class="flex space-x-4">
                    <div id="stage-user_to_communicator" class="flow-stage px-4 py-2 rounded-lg bg-gray-200 text-gray-700">
                        üì® –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –ö–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä
                    </div>
                    <div id="stage-communicator_thinking" class="flow-stage px-4 py-2 rounded-lg bg-gray-200 text-gray-700">
                        ü§î –ê–Ω–∞–ª–∏–∑
                    </div>
                    <div id="stage-group_chat" class="flow-stage px-4 py-2 rounded-lg bg-gray-200 text-gray-700">
                        üë• –ì—Ä—É–ø–ø-—á–∞—Ç
                    </div>
                    <div id="stage-agent_processing" class="flow-stage px-4 py-2 rounded-lg bg-gray-200 text-gray-700">
                        ‚ö° –û–±—Ä–∞–±–æ—Ç–∫–∞
                    </div>
                    <div id="stage-response_generation" class="flow-stage px-4 py-2 rounded-lg bg-gray-200 text-gray-700">
                        üìù –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
                    </div>
                </div>
                
                <div id="flowTimer" class="text-lg font-mono text-gray-600">00:00</div>
            </div>
        </div>
        
        <!-- Agent Network Visualization -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">üï∏Ô∏è –°–µ—Ç—å –∞–≥–µ–Ω—Ç–æ–≤</h3>
            
            <div class="agent-network relative h-96 rounded-lg border">
                <!-- –ê–≥–µ–Ω—Ç—ã –±—É–¥—É—Ç —Ä–∞–∑–º–µ—â–µ–Ω—ã –∑–¥–µ—Å—å —á–µ—Ä–µ–∑ JavaScript -->
                <div id="agentContainer" class="relative w-full h-full">
                    <!-- SVG –¥–ª—è —Å–≤—è–∑–µ–π –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏ -->
                    <svg id="connectionSvg" class="absolute inset-0 w-full h-full pointer-events-none">
                        <!-- –õ–∏–Ω–∏–∏ —Å–≤—è–∑–µ–π –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </svg>
                    
                    <!-- –ê–≥–µ–Ω—Ç—ã -->
                    <div id="agentContainer" class="relative w-full h-full">
                        <!-- –ê–≥–µ–Ω—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Current Flow Info -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">üìã –¢–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫</h3>
            <div id="currentFlowInfo" class="text-gray-600">
                –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
            </div>
        </div>
        
        <!-- Thought Stream -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">üí≠ –ü–æ—Ç–æ–∫ –º—ã—Å–ª–µ–π</h3>
            <div id="thoughtStream" class="space-y-4 max-h-64 overflow-y-auto">
                <div class="text-gray-500 text-center py-8">
                    –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –º—ã—Å–ª–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∞–≥–µ–Ω—Ç–æ–≤
                </div>
            </div>
        </div>
        
        <!-- Message Input for Visualization -->
        <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
            <div class="flex gap-2">
                <input type="text" id="visualizationMessageInput" 
                       placeholder="–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞..." 
                       class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                <button id="sendVisualizationBtn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    <i class="fas fa-rocket mr-2"></i>–ó–∞–ø—É—Å—Ç–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Mode -->
    <div id="dashboardMode" class="max-w-7xl mx-auto p-6 hidden">
        <!-- Dashboard content - existing content -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- System Status -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h3>
                <div id="systemMetrics" class="space-y-2">
                    <div class="flex justify-between">
                        <span>–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã:</span>
                        <span id="activeAgents" class="font-semibold">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span>–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π:</span>
                        <span id="totalMessages" class="font-semibold">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</span>
                        <span id="uptime" class="font-semibold">-</span>
                    </div>
                </div>
            </div>
            
            <!-- Memory Usage -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏</h3>
                <div id="memoryInfo" class="text-center">
                    <div class="text-3xl font-bold text-blue-600" id="memoryUsage">-</div>
                    <div class="text-sm text-gray-600">–ü–∞–º—è—Ç—å</div>
                </div>
            </div>
            
            <!-- CPU Usage -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">‚ö° –ó–∞–≥—Ä—É–∑–∫–∞ CPU</h3>
                <div id="cpuInfo" class="text-center">
                    <div class="text-3xl font-bold text-green-600" id="cpuUsage">-</div>
                    <div class="text-sm text-gray-600">CPU</div>
                </div>
            </div>
        </div>
        
        <!-- Agent Status -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">ü§ñ –°—Ç–∞—Ç—É—Å –∞–≥–µ–Ω—Ç–æ–≤</h3>
            <div id="agentStatus" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Agent cards will be populated here -->
            </div>
        </div>
    </div>

    <!-- Studio Mode -->
    <div id="studioMode" class="max-w-7xl mx-auto p-6 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">üé¨ AutoGen Studio</h2>
            <div class="border rounded-lg overflow-hidden" style="height: 80vh;">
                <iframe id="studioFrame" src="visualization.html" 
                        class="w-full h-full border-0">
                </iframe>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentMode = 'visualization';
        let api = null;
        let visualizationWs = null;
        let currentFlow = null;
        let flowStartTime = null;
        let agentProfiles = [];
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            api = new RootMASAPI();
            initializeVisualization();
            initializeEventListeners();
            loadAgentProfiles();
            switchMode('visualization');
        });
        
        // API –∫–ª–∞—Å—Å
        class RootMASAPI {
            constructor(baseURL = 'http://localhost:8000') {
                this.baseURL = baseURL;
            }
            
            async sendMessage(message, userId = 'pwa_user') {
                const response = await fetch(`${this.baseURL}/api/v1/chat/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, user_id: userId })
                });
                return await response.json();
            }
            
            async getAgentProfiles() {
                const response = await fetch(`${this.baseURL}/api/v1/agents/profiles`);
                return await response.json();
            }
            
            async getSystemMetrics() {
                const response = await fetch(`${this.baseURL}/api/v1/metrics/dashboard`);
                return await response.json();
            }
            
            async getAgentStatus() {
                const response = await fetch(`${this.baseURL}/api/v1/agents/status`);
                return await response.json();
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        function initializeVisualization() {
            // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
            visualizationWs = new WebSocket('ws://localhost:8000/ws/visualization');
            
            visualizationWs.onopen = function() {
                console.log('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ WebSocket –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏');
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –∞–≥–µ–Ω—Ç–æ–≤
                visualizationWs.send(JSON.stringify({type: 'get_agent_profiles'}));
            };
            
            visualizationWs.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleVisualizationEvent(data);
            };
            
            visualizationWs.onerror = function(error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ WebSocket:', error);
            };
            
            visualizationWs.onclose = function() {
                console.log('üì° WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(initializeVisualization, 5000);
            };
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π –∞–≥–µ–Ω—Ç–æ–≤
        async function loadAgentProfiles() {
            try {
                agentProfiles = await api.getAgentProfiles();
                renderAgentNetwork();
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π –∞–≥–µ–Ω—Ç–æ–≤:', error);
            }
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ç–∏ –∞–≥–µ–Ω—Ç–æ–≤
        function renderAgentNetwork() {
            const container = document.getElementById('agentContainer');
            const svg = document.getElementById('connectionSvg');
            
            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            container.innerHTML = '';
            svg.innerHTML = '';
            
            // –ü–æ–∑–∏—Ü–∏–∏ –∞–≥–µ–Ω—Ç–æ–≤ (–∫—Ä—É–≥–æ–≤–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ)
            const centerX = container.offsetWidth / 2;
            const centerY = container.offsetHeight / 2;
            const radius = Math.min(centerX, centerY) - 80;
            
            agentProfiles.forEach((agent, index) => {
                const angle = (2 * Math.PI * index) / agentProfiles.length;
                const x = centerX + radius * Math.cos(angle) - 40; // 40 = –ø–æ–ª–æ–≤–∏–Ω–∞ —à–∏—Ä–∏–Ω—ã –∞–≤–∞—Ç–∞—Ä–∞
                const y = centerY + radius * Math.sin(angle) - 40;
                
                // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –∞–≥–µ–Ω—Ç–∞
                const agentElement = document.createElement('div');
                agentElement.id = `agent-${agent.agent_id}`;
                agentElement.className = 'absolute w-20 h-20 cursor-pointer';
                agentElement.style.left = x + 'px';
                agentElement.style.top = y + 'px';
                
                agentElement.innerHTML = `
                    <div class="agent-avatar w-full h-full rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-2xl font-bold shadow-lg relative">
                        ${agent.name[0]}
                        <div class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 text-xs text-gray-700 font-medium whitespace-nowrap">
                            ${agent.name}
                        </div>
                    </div>
                `;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                agentElement.addEventListener('click', () => showAgentDetails(agent));
                
                container.appendChild(agentElement);
            });
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∞–≥–µ–Ω—Ç–∞
        function showAgentDetails(agent) {
            alert(`
ü§ñ ${agent.name}
–†–æ–ª—å: ${agent.role}
–û–ø–∏—Å–∞–Ω–∏–µ: ${agent.description}
–ù–∞–≤—ã–∫–∏: ${agent.capabilities.join(', ')}
            `);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        function handleVisualizationEvent(data) {
            console.log('üì° –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ:', data);
            
            switch(data.event_type || data.type) {
                case 'agent_profiles':
                    agentProfiles = data.data;
                    renderAgentNetwork();
                    break;
                    
                case 'message_flow_start':
                    startMessageFlowVisualization(data);
                    break;
                    
                case 'agent_thought':
                    addAgentThoughtVisualization(data);
                    break;
                    
                case 'flow_stage_update':
                    updateFlowStageVisualization(data);
                    break;
                    
                case 'message_flow_complete':
                    completeMessageFlowVisualization(data);
                    break;
            }
        }
        
        // –ù–∞—á–∞–ª–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Ç–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        function startMessageFlowVisualization(data) {
            currentFlow = data.flow_id;
            flowStartTime = Date.now();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ—Ç–æ–∫–µ
            document.getElementById('currentFlowInfo').innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-semibold">–ü–æ—Ç–æ–∫: ${data.flow_id}</div>
                        <div class="text-sm">–°–æ–æ–±—â–µ–Ω–∏–µ: "${data.data.user_message}"</div>
                    </div>
                    <div class="text-green-600 font-semibold">üü¢ –ê–∫—Ç–∏–≤–µ–Ω</div>
                </div>
            `;
            
            // –û—á–∏—â–∞–µ–º –ø–æ—Ç–æ–∫ –º—ã—Å–ª–µ–π
            document.getElementById('thoughtStream').innerHTML = '';
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
            startFlowTimer();
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é —Å—Ç–∞–¥–∏—é
            updateFlowStage('user_to_communicator');
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º—ã—Å–ª–∏ –∞–≥–µ–Ω—Ç–∞ –≤ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
        function addAgentThoughtVisualization(data) {
            const thoughtData = data.data;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º—ã—Å–ª—å –≤ –ø–æ—Ç–æ–∫
            addThoughtBubble(thoughtData);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∞–≥–µ–Ω—Ç–∞
            activateAgent(thoughtData.agent_id, thoughtData.thought_type);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤—è–∑—å –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏, –µ—Å–ª–∏ –µ—Å—Ç—å target_agent
            if (thoughtData.target_agent) {
                showAgentConnection(thoughtData.agent_id, thoughtData.target_agent);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–∏ –ø–æ—Ç–æ–∫–∞
        function updateFlowStageVisualization(data) {
            updateFlowStage(data.data.new_stage);
        }
        
        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Ç–æ–∫–∞
        function completeMessageFlowVisualization(data) {
            // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –∞–≥–µ–Ω—Ç—ã
            document.querySelectorAll('.agent-avatar').forEach(avatar => {
                avatar.classList.remove('active', 'thinking');
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Ç–æ–∫–µ
            document.getElementById('currentFlowInfo').innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-semibold">–ü–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω: ${currentFlow}</div>
                        <div class="text-sm">–û—Ç–≤–µ—Ç: "${data.data.final_response.substring(0, 100)}..."</div>
                        <div class="text-xs text-gray-500">–í—Å–µ–≥–æ –º—ã—Å–ª–µ–π: ${data.data.total_thoughts}, –í—Ä–µ–º—è: ${data.data.duration_ms}–º—Å</div>
                    </div>
                    <div class="text-gray-600 font-semibold">‚ö™ –ó–∞–≤–µ—Ä—à–µ–Ω</div>
                </div>
            `;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞–¥–∏–∏
            document.querySelectorAll('.flow-stage').forEach(stage => {
                stage.classList.remove('active');
            });
            
            currentFlow = null;
            flowStartTime = null;
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—É–∑—ã—Ä—è –º—ã—Å–ª–∏
        function addThoughtBubble(thought) {
            const thoughtStream = document.getElementById('thoughtStream');
            
            const thoughtElement = document.createElement('div');
            thoughtElement.className = 'thought-bubble animate-in bg-gray-100 rounded-lg p-4 border-l-4';
            
            // –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º—ã—Å–ª–µ–π
            const typeColors = {
                'receiving': 'border-blue-500',
                'thinking': 'border-yellow-500', 
                'responding': 'border-green-500',
                'forwarding': 'border-purple-500'
            };
            
            const typeIcons = {
                'receiving': 'üì®',
                'thinking': 'ü§î',
                'responding': 'üí¨',
                'forwarding': 'üîÑ'
            };
            
            thoughtElement.classList.add(typeColors[thought.thought_type] || 'border-gray-500');
            
            thoughtElement.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-sm font-bold">
                        ${thought.agent_name[0]}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="font-semibold text-gray-800">${thought.agent_name}</span>
                            <span class="text-sm text-gray-500">${typeIcons[thought.thought_type]} ${thought.thought_type}</span>
                            <span class="text-xs text-gray-400">${new Date(thought.timestamp * 1000).toLocaleTimeString()}</span>
                        </div>
                        <div class="text-gray-700">${thought.message}</div>
                        ${thought.target_agent ? `<div class="text-sm text-purple-600 mt-1">‚Üí ${thought.target_agent}</div>` : ''}
                    </div>
                </div>
            `;
            
            thoughtStream.appendChild(thoughtElement);
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–æ–≤–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
            thoughtElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
        
        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞
        function activateAgent(agentId, thoughtType) {
            // –°–Ω–∞—á–∞–ª–∞ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ—Ö
            document.querySelectorAll('.agent-avatar').forEach(avatar => {
                avatar.classList.remove('active', 'thinking');
            });
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω—É–∂–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
            const agentElement = document.getElementById(`agent-${agentId}`);
            if (agentElement) {
                const avatar = agentElement.querySelector('.agent-avatar');
                if (thoughtType === 'thinking') {
                    avatar.classList.add('thinking');
                } else {
                    avatar.classList.add('active');
                }
            }
        }
        
        // –ü–æ–∫–∞–∑ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏
        function showAgentConnection(fromAgentId, toAgentId) {
            const fromElement = document.getElementById(`agent-${fromAgentId}`);
            const toElement = document.getElementById(`agent-${toAgentId}`);
            
            if (fromElement && toElement) {
                const svg = document.getElementById('connectionSvg');
                
                // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—Ç—Ä—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                const fromRect = fromElement.getBoundingClientRect();
                const toRect = toElement.getBoundingClientRect();
                const containerRect = svg.getBoundingClientRect();
                
                const fromX = fromRect.left - containerRect.left + fromRect.width / 2;
                const fromY = fromRect.top - containerRect.top + fromRect.height / 2;
                const toX = toRect.left - containerRect.left + toRect.width / 2;
                const toY = toRect.top - containerRect.top + toRect.height / 2;
                
                // –°–æ–∑–¥–∞–µ–º –ª–∏–Ω–∏—é
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', fromX);
                line.setAttribute('y1', fromY);
                line.setAttribute('x2', toX);
                line.setAttribute('y2', toY);
                line.setAttribute('stroke', '#3b82f6');
                line.setAttribute('stroke-width', '2');
                line.classList.add('message-flow-line');
                
                svg.appendChild(line);
                
                // –£–¥–∞–ª—è–µ–º –ª–∏–Ω–∏—é —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    if (line.parentNode) {
                        line.parentNode.removeChild(line);
                    }
                }, 2000);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–∏ –ø–æ—Ç–æ–∫–∞
        function updateFlowStage(stageName) {
            document.querySelectorAll('.flow-stage').forEach(stage => {
                stage.classList.remove('active');
            });
            
            const stageElement = document.getElementById(`stage-${stageName}`);
            if (stageElement) {
                stageElement.classList.add('active');
            }
        }
        
        // –¢–∞–π–º–µ—Ä –ø–æ—Ç–æ–∫–∞
        function startFlowTimer() {
            const updateTimer = () => {
                if (flowStartTime) {
                    const elapsed = Date.now() - flowStartTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    document.getElementById('flowTimer').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (currentFlow) {
                        setTimeout(updateTimer, 1000);
                    }
                }
            };
            updateTimer();
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function initializeEventListeners() {
            // –ö–Ω–æ–ø–∫–∏ —Ä–µ–∂–∏–º–æ–≤
            document.getElementById('chatModeBtn').addEventListener('click', () => switchMode('chat'));
            document.getElementById('visualizationModeBtn').addEventListener('click', () => switchMode('visualization'));
            document.getElementById('dashboardModeBtn').addEventListener('click', () => switchMode('dashboard'));
            document.getElementById('studioModeBtn').addEventListener('click', () => switchMode('studio'));
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
            document.getElementById('sendVisualizationBtn').addEventListener('click', sendVisualizationMessage);
            document.getElementById('visualizationMessageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendVisualizationMessage();
                }
            });
            
            // –û–±—ã—á–Ω—ã–π —á–∞—Ç
            document.getElementById('sendMessageBtn').addEventListener('click', sendChatMessage);
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        async function sendVisualizationMessage() {
            const input = document.getElementById('visualizationMessageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                input.value = '';
                input.disabled = true;
                document.getElementById('sendVisualizationBtn').disabled = true;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                await api.sendMessage(message);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
            } finally {
                input.disabled = false;
                document.getElementById('sendVisualizationBtn').disabled = false;
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—ã—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        async function sendChatMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                input.value = '';
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç
                addMessageToChat(message, 'user');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                const response = await api.sendMessage(message);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ —á–∞—Ç
                addMessageToChat(response.response, 'agent');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                addMessageToChat('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessageToChat(message, sender) {
            const chatContainer = document.getElementById('chatContainer');
            
            const messageElement = document.createElement('div');
            messageElement.className = `mb-4 ${sender === 'user' ? 'text-right' : 'text-left'}`;
            
            const bubbleClass = sender === 'user' ? 'bg-blue-600 text-white' : 
                               sender === 'error' ? 'bg-red-100 text-red-800' : 'bg-gray-200 text-gray-800';
            
            messageElement.innerHTML = `
                <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${bubbleClass}">
                    ${message}
                </div>
                <div class="text-xs text-gray-500 mt-1">
                    ${new Date().toLocaleTimeString()}
                </div>
            `;
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (chatContainer.children.length === 1 && chatContainer.firstChild.textContent.includes('–ù–∞—á–Ω–∏—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä')) {
                chatContainer.innerHTML = '';
            }
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤
        function switchMode(mode) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ä–µ–∂–∏–º—ã
            document.getElementById('chatMode').classList.add('hidden');
            document.getElementById('visualizationMode').classList.add('hidden');
            document.getElementById('dashboardMode').classList.add('hidden');
            document.getElementById('studioMode').classList.add('hidden');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-white');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
            switch(mode) {
                case 'chat':
                    document.getElementById('chatMode').classList.remove('hidden');
                    document.getElementById('chatModeBtn').classList.add('ring-2', 'ring-white');
                    break;
                case 'visualization':
                    document.getElementById('visualizationMode').classList.remove('hidden');
                    document.getElementById('visualizationModeBtn').classList.add('ring-2', 'ring-white');
                    break;
                case 'dashboard':
                    document.getElementById('dashboardMode').classList.remove('hidden');
                    document.getElementById('dashboardModeBtn').classList.add('ring-2', 'ring-white');
                    loadDashboardData();
                    break;
                case 'studio':
                    document.getElementById('studioMode').classList.remove('hidden');
                    document.getElementById('studioModeBtn').classList.add('ring-2', 'ring-white');
                    break;
            }
            
            currentMode = mode;
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–∞
        async function loadDashboardData() {
            try {
                const [metrics, agentStatus] = await Promise.all([
                    api.getSystemMetrics(),
                    api.getAgentStatus()
                ]);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
                document.getElementById('activeAgents').textContent = metrics.active_agents || 0;
                document.getElementById('totalMessages').textContent = metrics.total_messages || 0;
                document.getElementById('uptime').textContent = metrics.uptime || 'N/A';
                document.getElementById('memoryUsage').textContent = metrics.memory_usage || 'N/A';
                document.getElementById('cpuUsage').textContent = (metrics.cpu_usage || 0) + '%';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–≥–µ–Ω—Ç–æ–≤
                const agentStatusContainer = document.getElementById('agentStatus');
                agentStatusContainer.innerHTML = '';
                
                agentStatus.forEach(agent => {
                    const agentCard = document.createElement('div');
                    agentCard.className = 'bg-gray-50 rounded-lg p-4';
                    agentCard.innerHTML = `
                        <h4 class="font-semibold">${agent.name}</h4>
                        <p class="text-sm text-gray-600">${agent.status}</p>
                        <p class="text-xs text-gray-500">–°–æ–æ–±—â–µ–Ω–∏–π: ${agent.message_count}</p>
                    `;
                    agentStatusContainer.appendChild(agentCard);
                });
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–∞:', error);
            }
        }
        
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker –¥–ª—è PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('‚úÖ SW –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'))
                .catch(error => console.log('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ SW:', error));
        }
    </script>
</body>
</html>