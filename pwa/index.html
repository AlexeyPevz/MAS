<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Root-MAS PWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    
    <!-- Tailwind CSS –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        .chat-message {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading {
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">ü§ñ Root-MAS</h1>
            <div class="flex space-x-4">
                <button id="tab-chat" class="px-4 py-2 rounded bg-blue-700">üí¨ –ß–∞—Ç</button>
                <button id="tab-dashboard" class="px-4 py-2 rounded">üìä Dashboard</button>
                <button id="tab-studio" class="px-4 py-2 rounded">üé¨ Studio</button>
            </div>
        </div>
    </nav>

    <!-- Chat Tab -->
    <div id="chat-tab" class="container mx-auto p-4">
        <div class="max-w-4xl mx-auto">
            <!-- Chat Messages -->
            <div id="chat-messages" class="bg-white rounded-lg shadow-lg p-4 h-96 overflow-y-auto mb-4">
                <div class="text-gray-500 text-center">
                    üí¨ –ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å –≤–∞—à–∏–º AI –ø–æ–º–æ—â–Ω–∏–∫–æ–º
                </div>
            </div>
            
            <!-- Voice Controls -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
                <div class="flex items-center space-x-4">
                    <button id="voice-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-full">
                        üé§ –ì–æ–≤–æ—Ä–∏—Ç—å
                    </button>
                    <div id="voice-status" class="text-gray-600">
                        –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    </div>
                </div>
            </div>
            
            <!-- Message Input -->
            <div class="bg-white rounded-lg shadow-lg p-4">
                <div class="flex space-x-4">
                    <input 
                        type="text" 
                        id="message-input" 
                        placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                        class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500"
                    >
                    <button 
                        id="send-btn" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg"
                    >
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="container mx-auto p-4 hidden">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- System Status -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h3>
                <div id="system-metrics" class="space-y-2">
                    <div class="flex justify-between">
                        <span>Uptime:</span>
                        <span id="uptime">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span>–°–æ–æ–±—â–µ–Ω–∏–π:</span>
                        <span id="total-messages">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span>–ê–≥–µ–Ω—Ç–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ:</span>
                        <span id="active-agents">--</span>
                    </div>
                </div>
            </div>
            
            <!-- Agents Status -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">ü§ñ –ê–≥–µ–Ω—Ç—ã</h3>
                <div id="agents-status" class="space-y-2">
                    <!-- –ê–≥–µ–Ω—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ API -->
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">üìù –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                <div id="recent-activity" class="space-y-2 text-sm">
                    <!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ API -->
                </div>
            </div>
        </div>
    </div>

    <!-- Studio Tab (iframe) -->
    <div id="studio-tab" class="hidden">
        <iframe 
            id="studio-iframe"
            src="http://localhost:8081" 
            class="w-full h-screen border-0"
            title="AutoGen Studio"
        >
        </iframe>
    </div>

    <!-- API Integration Script -->
    <script>
        class RootMASAPI {
            constructor(baseURL = 'http://localhost:8000') {
                this.baseURL = baseURL;
                this.websocket = null;
            }
            
            // API –º–µ—Ç–æ–¥—ã
            async sendMessage(message, userId = 'pwa_user') {
                try {
                    const response = await fetch(`${this.baseURL}/api/v1/chat/message`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            user_id: userId,
                            metadata: {
                                source: 'pwa',
                                timestamp: new Date().toISOString()
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Error sending message:', error);
                    throw error;
                }
            }
            
            async getSystemMetrics() {
                try {
                    const response = await fetch(`${this.baseURL}/api/v1/metrics/dashboard`);
                    return await response.json();
                } catch (error) {
                    console.error('Error getting metrics:', error);
                    return null;
                }
            }
            
            async getAgentsStatus() {
                try {
                    const response = await fetch(`${this.baseURL}/api/v1/agents/status`);
                    return await response.json();
                } catch (error) {
                    console.error('Error getting agents status:', error);
                    return null;
                }
            }
            
            async getChatHistory(limit = 20) {
                try {
                    const response = await fetch(`${this.baseURL}/api/v1/chat/history?limit=${limit}`);
                    return await response.json();
                } catch (error) {
                    console.error('Error getting chat history:', error);
                    return null;
                }
            }
            
            // WebSocket –¥–ª—è real-time
            connectWebSocket() {
                const wsURL = this.baseURL.replace('http', 'ws') + '/ws';
                this.websocket = new WebSocket(wsURL);
                
                this.websocket.onopen = () => {
                    console.log('WebSocket connected');
                };
                
                this.websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };
                
                this.websocket.onclose = () => {
                    console.log('WebSocket disconnected');
                    // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    setTimeout(() => this.connectWebSocket(), 5000);
                };
            }
            
            handleWebSocketMessage(data) {
                if (data.type === 'new_message') {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—Ç –≤ real-time
                    this.displayMessage(data.data.response, 'agent');
                }
            }
            
            displayMessage(text, sender = 'user') {
                const messagesDiv = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message mb-4 ${sender === 'user' ? 'text-right' : 'text-left'}`;
                
                const bubble = document.createElement('div');
                bubble.className = `inline-block px-4 py-2 rounded-lg max-w-xs lg:max-w-md ${
                    sender === 'user' 
                        ? 'bg-blue-500 text-white' 
                        : 'bg-gray-200 text-gray-800'
                }`;
                bubble.textContent = text;
                
                const avatar = document.createElement('div');
                avatar.className = 'text-sm text-gray-500 mt-1';
                avatar.textContent = sender === 'user' ? 'üë§ –í—ã' : 'ü§ñ Communicator';
                
                messageDiv.appendChild(bubble);
                messageDiv.appendChild(avatar);
                messagesDiv.appendChild(messageDiv);
                
                // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const api = new RootMASAPI();
        let isRecording = false;
        let mediaRecorder = null;
        
        // Tabs management
        function showTab(tabName) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ç–∞–±—ã
            document.querySelectorAll('[id$="-tab"]').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —Ç–∞–±
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('bg-blue-700');
            });
            document.getElementById('tab-' + tabName).classList.add('bg-blue-700');
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket
            api.connectWebSocket();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
            loadChatHistory();
            
            // Tabs
            document.getElementById('tab-chat').addEventListener('click', () => showTab('chat'));
            document.getElementById('tab-dashboard').addEventListener('click', () => {
                showTab('dashboard');
                loadDashboard();
            });
            document.getElementById('tab-studio').addEventListener('click', () => showTab('studio'));
            
            // Chat
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // Voice
            document.getElementById('voice-btn').addEventListener('click', toggleRecording);
        });
        
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            api.displayMessage(message, 'user');
            input.value = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'text-center text-gray-500';
            loadingDiv.innerHTML = '<div class="loading w-6 h-6 border-4 border-gray-200 rounded-full mx-auto"></div>';
            document.getElementById('chat-messages').appendChild(loadingDiv);
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ API
                const response = await api.sendMessage(message);
                
                // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                loadingDiv.remove();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –Ω–µ –ø—Ä–∏—à–µ–ª —á–µ—Ä–µ–∑ WebSocket)
                if (response.response) {
                    api.displayMessage(response.response, 'agent');
                }
                
            } catch (error) {
                loadingDiv.remove();
                api.displayMessage('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'system');
            }
        }
        
        async function loadChatHistory() {
            try {
                const history = await api.getChatHistory(10);
                if (history && history.messages) {
                    history.messages.forEach(msg => {
                        api.displayMessage(msg.user_message, 'user');
                        api.displayMessage(msg.agent_response, 'agent');
                    });
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }
        
        async function loadDashboard() {
            try {
                // –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
                const metrics = await api.getSystemMetrics();
                if (metrics) {
                    document.getElementById('uptime').textContent = metrics.uptime || '--';
                    document.getElementById('total-messages').textContent = metrics.total_messages || '0';
                    document.getElementById('active-agents').textContent = metrics.active_agents || '0';
                }
                
                // –°—Ç–∞—Ç—É—Å –∞–≥–µ–Ω—Ç–æ–≤
                const agents = await api.getAgentsStatus();
                if (agents && agents.agents) {
                    const agentsDiv = document.getElementById('agents-status');
                    agentsDiv.innerHTML = '';
                    
                    agents.agents.forEach(agent => {
                        const agentDiv = document.createElement('div');
                        agentDiv.className = 'flex justify-between items-center';
                        agentDiv.innerHTML = `
                            <span>${agent.name}</span>
                            <span class="text-sm ${agent.status === 'active' ? 'text-green-500' : 'text-gray-500'}">
                                ${agent.status === 'active' ? 'üü¢' : 'üî¥'} ${agent.status}
                            </span>
                        `;
                        agentsDiv.appendChild(agentDiv);
                    });
                }
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        // Voice Recording (–∑–∞–≥–ª—É—à–∫–∞)
        async function toggleRecording() {
            const btn = document.getElementById('voice-btn');
            const status = document.getElementById('voice-status');
            
            if (!isRecording) {
                // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    
                    btn.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                    btn.className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full';
                    status.textContent = 'üé§ –ò–¥–µ—Ç –∑–∞–ø–∏—Å—å...';
                    
                    mediaRecorder.start();
                    isRecording = true;
                    
                    mediaRecorder.ondataavailable = (event) => {
                        // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Speech-to-Text
                        console.log('Audio data available:', event.data);
                    };
                    
                } catch (error) {
                    console.error('Microphone access denied:', error);
                    status.textContent = '‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
                }
            } else {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                btn.textContent = 'üé§ –ì–æ–≤–æ—Ä–∏—Ç—å';
                btn.className = 'bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-full';
                status.textContent = '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...';
                
                isRecording = false;
                
                // –ó–∞–≥–ª—É—à–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –≥–æ–ª–æ—Å "—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω"
                setTimeout(() => {
                    status.textContent = '–ì–æ–ª–æ—Å —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω (–ø–æ–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)';
                    setTimeout(() => {
                        status.textContent = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è';
                    }, 2000);
                }, 1000);
            }
        }
    </script>
</body>
</html>