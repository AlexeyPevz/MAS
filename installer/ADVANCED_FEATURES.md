# Продвинутые возможности инсталляторов AI Memory System

## 🛡️ Система обработки ошибок и восстановления

### Автоматическая обработка ошибок

Все инсталляторы теперь оснащены интеллектуальной системой обработки ошибок, которая:

- **Автоматически диагностирует** проблемы во время установки
- **Предлагает решения** для типичных ошибок
- **Пытается исправить** проблемы автоматически
- **Повторяет неудачные шаги** после исправления

### Типы обрабатываемых ошибок

#### 1. Недостаточно места на диске
```
⚠️ Недостаточно места на диске!
Свободно: 1.2 GB из 50.0 GB (97.6% занято)

🧹 Варианты освобождения места:
1. Очистить логи (523.4 MB)
2. Очистить кэш (1.2 GB)
3. Очистить временные файлы (342.1 MB)
4. Удалить старые виртуальные окружения (2.3 GB)

💾 Можно освободить до 4.3 GB
Выполнить автоматическую очистку? [y/N]:
```

Система автоматически:
- Находит и удаляет старые логи (>100MB)
- Очищает pip и npm кэш
- Удаляет временные файлы старше 24 часов
- Предлагает удалить старые venv (>30 дней)

#### 2. Конфликты портов
```
⚠️ Обнаружен конфликт портов!

🔍 Занятые порты:
  Порт 8000: python (PID: 12345)
  Порт 5000: node (PID: 23456)

🛠️ Варианты решения:
1. Остановить конфликтующие процессы
2. Использовать другие порты
3. Перезапустить с --force флагом

Попытаться остановить конфликтующие процессы? [y/N]:
```

#### 3. Недостаточно памяти
```
⚠️ Недостаточно оперативной памяти!

💾 Использование памяти:
  RAM: 92% (14.7 GB из 16.0 GB)
  Swap: 85% (3.4 GB из 4.0 GB)

🔍 Процессы с высоким потреблением памяти:
  chrome: 4.2 GB (26.3%)
  docker: 2.8 GB (17.5%)
  code: 1.9 GB (11.9%)

🛠️ Варианты решения:
1. Закрыть ненужные приложения
2. Увеличить swap файл
3. Перезагрузить систему
4. Использовать --low-memory режим установки
```

#### 4. Проблемы с правами доступа
```
⚠️ Недостаточно прав доступа!
Требуются права администратора (sudo)

🛠️ Варианты решения:
1. Перезапустить с sudo: sudo python install.py
2. Изменить путь установки на домашнюю директорию
3. Исправить права на директорию установки
```

#### 5. Проблемы с сетью
```
⚠️ Ошибка подключения!
✗ Нет подключения к интернету

🛠️ Варианты решения:
1. Проверить сетевое подключение
2. Проверить настройки прокси
3. Использовать офлайн установку (если доступна)

Использовать офлайн кэш для установки? [y/N]:
```

### Режим восстановления

Если установка прерывается, система автоматически:
1. Сохраняет состояние установки
2. При повторном запуске предлагает продолжить с места остановки
3. Повторяет только неудачные шаги

## 🩺 System Doctor - Утилита диагностики

### Запуск диагностики
```bash
# Полная диагностика
python installer/system_doctor.py

# Автоматическое исправление
python installer/system_doctor.py --fix

# Проверка конкретной подсистемы
python installer/system_doctor.py --check memory
python installer/system_doctor.py --check network

# Сохранение отчета
python installer/system_doctor.py --report diagnostic.json
```

### Что проверяет System Doctor

1. **Системная информация**
   - ОС и версия
   - Архитектура
   - Python версия
   - Виртуальное окружение

2. **Ресурсы**
   - CPU использование
   - Память (RAM/Swap)
   - Дисковое пространство
   - Сетевые порты

3. **Зависимости**
   - Python пакеты
   - Системные команды (git, docker, node)
   - Конфигурационные файлы

4. **Установка**
   - Наличие AI Memory System
   - Структура директорий
   - Конфигурация
   - API токены

5. **Сервисы**
   - Systemd сервис
   - Docker контейнеры
   - Запущенные процессы

6. **Анализ логов**
   - Последние ошибки
   - Паттерны проблем
   - Рекомендации

### Пример вывода диагностики
```
╔══════════════════════════════════════════════╗
║         AI Memory System Doctor              ║
║     Диагностика и восстановление v1.0        ║
╚══════════════════════════════════════════════╝

🔍 Запуск диагностики системы...

📊 Системная информация
┌─────────────────┬──────────────────────┐
│ Platform        │ Linux                │
│ Version         │ 5.15.0-56-generic    │
│ Architecture    │ x86_64               │
│ Python Version  │ 3.11.4               │
│ Hostname        │ ai-server            │
│ User            │ ubuntu               │
│ In Venv         │ True                 │
└─────────────────┴──────────────────────┘

💾 Системные ресурсы
┌─────────┬────────────────────────────┬──────────┐
│ Ресурс  │ Использование              │ Статус   │
├─────────┼────────────────────────────┼──────────┤
│ CPU     │ 23% (8 ядер)               │ OK       │
│ Память  │ 67.3% (10.7 / 15.9 GB)     │ OK       │
│ Диск    │ 82.1% (свободно 8.9 GB)    │ WARNING  │
└─────────┴────────────────────────────┴──────────┘

⚠️ Обнаруженные проблемы
┌───────────┬─────────────────────────────────────┬──────────┐
│ Тип       │ Проблема                            │ Важность │
├───────────┼─────────────────────────────────────┼──────────┤
│ DISK      │ Мало свободного места: 8.9 GB       │ MEDIUM   │
│ PORT      │ Порт 8000 занят python (PID: 1234)  │ MEDIUM   │
│ CONFIG    │ Отсутствуют токены: OPENAI_API_KEY  │ MEDIUM   │
└───────────┴─────────────────────────────────────┴──────────┘

🔧 Обнаружено проблем: 3
Попытаться исправить автоматически? [y/N]:
```

## 🔄 Режимы установки

### 1. Интерактивный режим (по умолчанию)
Пошаговая установка с подсказками и выбором опций.

### 2. Быстрая установка
```bash
# С настройками по умолчанию
python install.py --quick

# С кастомными параметрами
python installer/cli_installer.py --quick \
    --path /opt/ai-memory \
    --memory chromadb \
    --tokens OPENAI_API_KEY=sk-... \
    --yes
```

### 3. Тихая установка (для CI/CD)
```bash
# Полностью автоматическая без вопросов
python installer/cli_installer.py \
    --quick \
    --yes \
    --path /opt/ai-memory \
    --no-interactive
```

### 4. Офлайн установка
```bash
# Подготовка офлайн кэша
python installer/prepare_offline.py

# Установка без интернета
python installer/cli_installer.py --offline
```

## 🎯 Специальные возможности

### 1. Продолжение прерванной установки
Если установка была прервана, при следующем запуске:
```
🔄 Обнаружена незавершенная установка
Последний успешный шаг: Установка Python пакетов
Продолжить с этого места? [Y/n]:
```

### 2. Откат изменений
При критической ошибке система может откатить изменения:
```
❌ Критическая ошибка при установке
Выполнить откат изменений? [Y/n]:
```

### 3. Проверка целостности
После установки автоматически проверяется:
- Все ли файлы на месте
- Корректность конфигурации
- Доступность API endpoints
- Работоспособность базовых функций

### 4. Автообновление
```bash
# Проверка обновлений
python installer/check_updates.py

# Обновление системы
python installer/update_system.py
```

## 📊 Мониторинг установки

### Логирование
Все действия логируются в:
- `installer/logs/install_YYYYMMDD_HHMMSS.log` - детальный лог
- `installer/logs/errors.log` - только ошибки
- `installer/logs/summary.log` - краткая сводка

### Метрики установки
После установки доступна статистика:
```
📊 Статистика установки:
  Время установки: 5 мин 23 сек
  Размер установки: 1.2 GB
  Установлено пакетов: 47
  Исправлено проблем: 3
  Использовано памяти: max 512 MB
  Скачано данных: 156 MB
```

## 🆘 Решение сложных проблем

### 1. Корпоративный прокси
```bash
# Установка через прокси
export HTTP_PROXY=http://proxy.company.com:8080
export HTTPS_PROXY=http://proxy.company.com:8080
python install.py
```

### 2. Ограниченные права
```bash
# Установка в пользовательскую директорию
python install.py --user-install --path ~/.local/ai-memory
```

### 3. Старая версия Python
```bash
# Использование pyenv для установки нужной версии
curl https://pyenv.run | bash
pyenv install 3.11.0
pyenv local 3.11.0
python install.py
```

### 4. Проблемы с SSL
```bash
# Временное отключение проверки SSL
export PYTHONHTTPSVERIFY=0
export PIP_TRUSTED_HOST="pypi.org files.pythonhosted.org"
python install.py
```

## 🔐 Безопасность

### Шифрование токенов
Все API токены:
- Хранятся в зашифрованном виде
- Никогда не попадают в логи
- Могут быть введены из файла или переменных окружения

### Проверка подписей
- Проверка контрольных сумм скачиваемых файлов
- Валидация SSL сертификатов
- Проверка источников пакетов

## 🎨 Кастомизация

### Создание своего профиля установки
```yaml
# install_profile.yaml
name: production
install_path: /opt/ai-memory
memory:
  type: qdrant
  size: 4096
  persistence: true
components:
  - core
  - api
  - web-ui
  - monitoring
services:
  systemd: true
  docker: false
  nginx: true
```

Использование:
```bash
python install.py --profile install_profile.yaml
```

### Плагины для инсталлятора
Создайте файл `installer/plugins/my_plugin.py`:
```python
class MyPlugin:
    def pre_install(self, config):
        """Выполняется перед установкой"""
        pass
        
    def post_install(self, config):
        """Выполняется после установки"""
        pass
        
    def on_error(self, error, context):
        """Обработка специфичных ошибок"""
        pass
```

## 📈 Производительность

### Параллельная установка
```bash
# Включить параллельную установку пакетов
python install.py --parallel --workers 4
```

### Кэширование
- Автоматическое кэширование скачанных пакетов
- Переиспользование виртуальных окружений
- Инкрементальные обновления

### Оптимизация для слабых систем
```bash
# Режим минимального потребления ресурсов
python install.py --low-memory --no-compile-bytecode
```

---

Эти продвинутые возможности делают процесс установки AI Memory System максимально надежным и удобным даже в сложных условиях!