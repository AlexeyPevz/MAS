#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Root-MAS —Å–∏—Å—Ç–µ–º—ã

echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Root-MAS —Å–∏—Å—Ç–µ–º—É..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º lock-—Ñ–∞–π–ª
if [ -f "run_system.lock" ]; then
    PID=$(cat run_system.lock)
    echo "üìç –ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å —Å PID: $PID"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
    if kill -0 $PID 2>/dev/null; then
        echo "üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏..."
        kill -TERM $PID
        
        # –ñ–¥–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
        COUNT=0
        while kill -0 $PID 2>/dev/null && [ $COUNT -lt 10 ]; do
            echo -n "."
            sleep 1
            COUNT=$((COUNT+1))
        done
        echo
        
        # –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –≤—Å–µ –µ—â–µ –∂–∏–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º SIGKILL
        if kill -0 $PID 2>/dev/null; then
            echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º SIGKILL..."
            kill -9 $PID
            sleep 1
        fi
        
        echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    else
        echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å $PID –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
    
    # –£–¥–∞–ª—è–µ–º lock-—Ñ–∞–π–ª
    rm -f run_system.lock
    echo "üîì Lock-—Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω"
else
    echo "‚ÑπÔ∏è  Lock-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞"
fi

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã Python
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ—Ü–µ—Å—Å—ã..."
PIDS=$(pgrep -f "python.*run_system.py")
if [ ! -z "$PIDS" ]; then
    echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã: $PIDS"
    echo "   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'pkill -f run_system.py' –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"
else
    echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å—ã Python –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º systemd —Å–µ—Ä–≤–∏—Å
if systemctl is-active mas-system.service &>/dev/null; then
    echo "üîß –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º systemd —Å–µ—Ä–≤–∏—Å..."
    sudo systemctl stop mas-system.service
fi

echo "‚úÖ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"