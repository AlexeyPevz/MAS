# Решение проблемы циклического перезапуска run_system.py

## Проблема

Скрипт `run_system.py` постоянно перезапускался без видимых ошибок. Основные причины:

1. **Отсутствие механизма предотвращения множественных запусков** - скрипт мог запускаться несколько раз параллельно
2. **Агрессивная очистка процессов** - функция `cleanup_old_processes()` могла убивать собственные дочерние процессы
3. **Systemd конфигурация** - параметр `Restart=always` вызывал автоматический перезапуск даже при нормальном завершении
4. **Отсутствие зависимостей** - при первом запуске многие модули не были установлены

## Внесенные изменения

### 1. Добавлен механизм lock-файла

```python
# Проверяем lock-файл для предотвращения множественных запусков
lock_file = Path("run_system.lock")
if lock_file.exists():
    # Проверяем, жив ли процесс
    try:
        with open(lock_file, 'r') as f:
            old_pid = int(f.read().strip())
        
        # Проверяем существование процесса
        try:
            os.kill(old_pid, 0)  # Не убивает, только проверяет
            print(f"❌ Система уже запущена (PID: {old_pid})")
            print("   Используйте 'kill' для остановки или удалите run_system.lock")
            sys.exit(1)
        except ProcessLookupError:
            # Процесс не существует, удаляем старый lock
            lock_file.unlink()
    except Exception:
        # Ошибка чтения lock-файла, удаляем его
        lock_file.unlink()

# Создаем новый lock-файл
with open(lock_file, 'w') as f:
    f.write(str(os.getpid()))
```

### 2. Правильная очистка lock-файла

Lock-файл удаляется:
- При получении сигнала остановки (SIGINT, SIGTERM)
- В блоке `finally` при завершении программы
- При любой ошибке

### 3. Временно отключена агрессивная очистка процессов

```python
# Очищаем старые процессы (только если нет активного lock-файла)
# cleanup_old_processes()  # Временно отключено для отладки
```

### 4. Исправлена конфигурация systemd

Изменено с:
```ini
Restart=always
RestartSec=10
```

На:
```ini
Restart=on-failure
RestartSec=30
StartLimitBurst=3
StartLimitIntervalSec=600
```

Это означает:
- Перезапуск только при ошибке (не при нормальном завершении)
- Ожидание 30 секунд перед перезапуском
- Максимум 3 попытки перезапуска за 10 минут

### 5. Добавлен скрипт безопасной остановки

Создан `stop_system.sh` для корректной остановки системы:
- Проверяет lock-файл
- Отправляет SIGTERM процессу
- Ждет завершения
- Удаляет lock-файл
- Проверяет оставшиеся процессы

## Рекомендации

1. **Установите все зависимости перед запуском**:
   ```bash
   pip3 install -r requirements.txt --break-system-packages
   ```

2. **Используйте stop_system.sh для остановки**:
   ```bash
   ./stop_system.sh
   ```

3. **При проблемах проверьте**:
   - Наличие файла `run_system.lock`
   - Запущенные процессы: `ps aux | grep run_system`
   - Логи в `logs/system.log`

4. **Для отладки используйте**:
   - `run_system_fixed.py` - упрощенная версия без лишней логики
   - `test_startup.py` - диагностический скрипт

## Дополнительные улучшения

1. Можно добавить более умную логику в `cleanup_old_processes()`:
   - Проверять lock-файл перед очисткой
   - Не трогать процессы с активным lock-файлом
   - Использовать более точные критерии для идентификации старых процессов

2. Добавить мониторинг состояния:
   - Периодическая проверка здоровья компонентов
   - Метрики для Prometheus
   - Логирование причин остановки

3. Улучшить обработку ошибок:
   - Разделить критические и некритические ошибки
   - Добавить retry логику для временных сбоев
   - Graceful degradation при отсутствии некоторых компонентов